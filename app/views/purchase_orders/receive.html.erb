<h1>Receive purchase order</h1>

<%= form_for(@purchase_order, url: receive_purchase_order_path(@purchase_order), method: :post) do |f| %>
  <% if @purchase_order.errors.any? %>
    <div id="error_explanation">
        <h2><%= pluralize(@purchase_order.errors.count, "error") %> prohibited this purchase_order from being saved:</h2>

        <ul>
            <% @purchase_order.errors.full_messages.each do |msg| %>
              <li><%= msg %></li>
            <% end %>
        </ul>
    </div>
  <% end %>
  <%= f.hidden_field :receiving_po %>
  <table>
      <tr>
          <td>Number</td>
          <td>:</td>
          <td><%= @purchase_order.number %></td>
      </tr>
      <tr>
          <td>To</td>
          <td>:</td>
          <td><%= @purchase_order.vendor.name if @purchase_order.vendor %></td>
      </tr>
      <tr>
          <td align="center" colspan="3">
              <table border="1">
                  <tbody>
                      <tr>
                          <th>No</th>
                          <th>Warehouse Name</th>
                          <th>Article Code</th>
                          <th>Details</th>
                      </tr>
                      <% @purchase_order.purchase_order_products.each_with_index do |po_product, idx| %>
                        <%= f.fields_for :purchase_order_products, po_product do |purchase_order_product_form| %>
                          <tr align="center">
                              <td><%= idx.succ %></td>
                              <td><%= po_product.warehouse.name if po_product.warehouse %></td>
                              <td><%= po_product.product.code if po_product.product %></td>
                              <td>
                                  <table border="1" width="100%">
                                      <tbody>
                                          <tr>
                                              <td colspan="2" rowspan="2"></td>
                                              <td align="center" colspan="<%= po_product.sizes.length %>">Sizes</td>
                                          </tr>
                                          <tr>
                                              <% po_product.sizes.each do |size| %>
                                                <td align="center"><%= size.size %></td>
                                              <% end %>
                                          </tr>
                                          <% po_product.colors.each_with_index do |color, idx| %>
                                            <tr>
                                                <% if idx == 0 %>
                                                  <td valign="middle" rowspan="<%= po_product.colors.length %>">Colors</td>
                                                <% end %>
                                                <td>
                                                    <% received_purchase_order = po_product.received_purchase_orders.select{|rpo| rpo.color.eql?(color)}.first %>
                                                    <%= purchase_order_product_form.fields_for :received_purchase_orders, received_purchase_order do |received_purchase_order_detail_form| %>
                                                      <%= received_purchase_order_detail_form.hidden_field :id %>
                                                      <%= received_purchase_order_detail_form.hidden_field :color_id %>
                                                      <%= received_purchase_order_detail_form.hidden_field :purchase_order_product_id %>
                                                      <% if received_purchase_order.new_record? %>
                                                        <%= received_purchase_order_detail_form.check_box :is_received %>
                                                      <% else %>
                                                        <%= received_purchase_order_detail_form.hidden_field :is_received, value: 1 %>
                                                        &#x2713;
                                                      <% end %>
                                                    <% end %>
                                                    <%= color.code %>
                                                </td>
                                                <% po_product.sizes.each do |size| %>
                                                  <% po_detail = po_product.purchase_order_details.select{ |pod| pod.color.eql?(color) && pod.size.eql?(size) }.first %>
                                                  <td>
                                                      <% if po_detail %>
                                                        <%= po_detail.quantity %> pcs
                                                      <% end %>
                                                  </td>
                                                <% end %>
                                            </tr>
                                          <% end %>
                                      </tbody>
                                  </table>
                              </td>
                          </tr>
                        <% end %>
                      <% end %>
                  </tbody>
              </table>
          </td>
      </tr>
  </table>
  <div class="actions">
      <%= f.submit "Save", data: { confirm: "This action cannot be undone\nAre you sure?" } %>
  </div>
<% end %>

<%= link_to 'Back', purchase_orders_path %>
