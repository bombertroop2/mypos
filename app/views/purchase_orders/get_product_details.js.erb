if($("#products_detail").html().trim().length == 0)
  $("#products_detail").html("<%= j(render(partial: "product_quantities")) %>");
else  {
  var previousSelectedProductIds = [];
  var selectedProductIds = "<%= params[:product_ids] %>".split(",");
  $(".product-table").each(function(){
    var id = $(this).attr("id").split("_")[2];
    previousSelectedProductIds.push(id);
  });
  
  
  var retainedProductIds = intersection(previousSelectedProductIds, selectedProductIds);
  
  // remove unuse product
  $(".product-table").each(function(){
    var id = $(this).attr("id").split("_")[2];
    if(retainedProductIds.indexOf(id) == -1)
      $(this).remove();    
  });
  
  
  
  
  
  if(!($(previousSelectedProductIds).not(selectedProductIds).length === 0 && $(selectedProductIds).not(previousSelectedProductIds).length === 0))  {
    $("#products_detail").append("<%= j(render(partial: "product_quantities")) %>");
    // remove double product
    var duplicateCount = 0;
    $(".product-table").each(function(){
      var id = $(this).attr("id").split("_")[2];
      if(retainedProductIds.indexOf(id) != -1)
        duplicateCount++;
      if(duplicateCount == 2){
        duplicateCount = 0;
        $(this).remove();
      }
    });
    // end remove double product
  }
  
}
