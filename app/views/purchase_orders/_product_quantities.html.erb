<%= hidden_field_tag "product_ids", params[:product_ids] %>
<table border="1">
    <tr style="text-align: center">
        <th>Product code</th>
        <th>Size X Color</th>
    </tr>
    <% @products.each do |product| %>
      <tr>
          <th>
              <%= product.code %>
          </th>
          <td>
              <% purchase_order_product_detail = get_or_build_purchase_order_product_object(@purchase_order, product) %>
              <% purchase_order_product_array_index = create_product_array_variable_name(purchase_order_product_detail, product) %>
              <%= fields_for purchase_order_product_array_index, purchase_order_product_detail do |purchase_order_product_detail_form| %>
                <%= purchase_order_product_detail_form.hidden_field :id %>
                <%= purchase_order_product_detail_form.hidden_field :product_id %>
                <%= purchase_order_product_detail_form.select :warehouse_id, options_from_collection_for_select(@store_warehouses, :id, :name), {prompt: true} %>
              <% end %>

              <% colors = product.colors %>
              <% sizes = product.sizes %>
              <% index = 0 %>

              <script>
                var colorCodes = [];
              </script>

              <table border="1">
                  <tr style="text-align: center">
                      <th colspan="2" rowspan="2"></th>
                      <th colspan="<%= colors.size %>">Colors<br /><%= text_field_tag "quantity_#{product.id}", "", {placeholder: "quantity", style: "text-align:right;", size: 16, class: "quantity"} %></th>
                    </tr>

                    <tr style="text-align: center">
                        <% colors.each do |color| %>
                          <td><%= color.code %><br /><%= text_field_tag "quantity_#{product.id}_#{color.code}", "", {placeholder: "quantity", class: "quantity-#{product.id} quantity", style: "text-align:right;", size: 16} %></td>
                          <% end %>
                      </tr>

                      <% sizes.each_with_index do |size, idx| %>                          
                        <tr style="text-align: center">
                            <% if idx.eql? 0 %>
                              <th rowspan="<%= sizes.size %>">Sizes</th>
                            <% end %>
                            <td><%= size.size %></td>                            
                            <% colors.each do |color| %>
                              <% if idx == 0 %>
                            <script>
                              colorCodes.push('<%= color.code %>');
                            </script>
                          <% end %>
                          <% product_detail = product.grouped_product_details.select{|pd| pd.size_id.eql?(size.id) && pd.color_id.eql?(color.id)}.first %>
                          <% if product_detail.present? %>
                            <% purchase_order_detail_detail = get_or_build_purchase_order_detail_object(purchase_order_product_detail, product_detail) %>
                            <% purchase_order_detail_array_index = create_product_detail_array_variable_name(purchase_order_detail_detail, index, purchase_order_product_array_index) %>
                            <td>
                                <%= fields_for purchase_order_detail_array_index, purchase_order_detail_detail do |purchase_order_detail_detail_form| %>
                                  <%= purchase_order_detail_detail_form.hidden_field :id %>
                                  <%= purchase_order_detail_detail_form.hidden_field :product_detail_id %>
                                  <div class="field">
                                      <%= purchase_order_detail_detail_form.text_field :quantity, placeholder: "quantity", class: "quantity-#{product.id}-#{color.code} quantity-#{product.id} quantity", style: "text-align:right;", size: 16 %>
                                    </div>  
                                  <% end %>

                              </td>
                              <% index += 1 %>
                            <% else %>
                              <td>
                              </td>
                            <% end %>
                          <% end %>
              </tr>
            <% end %>              
        </table></td>
        </tr>
        <script>
          $.each(colorCodes, function (index, value) {
              $('#quantity_<%= product.id %>_' + value).keyup(function () {
                  $('.quantity-<%= product.id %>-' + value).val($('#quantity_<%= product.id %>_' + value).val());
              });
          });
          $('#<%= "quantity_#{product.id}" %>').keyup(function () {
              $('.quantity-<%= product.id %>').val($('#<%= "quantity_#{product.id}" %>').val());
          });
        </script>        
      <% end %>
      </table>

      <script>
        $(".quantity").numeric({
            decimal: false,
            negative: false
        }, function () {
            alert("Positive integers only");
            this.value = "";
            this.focus();
        });

      </script>

